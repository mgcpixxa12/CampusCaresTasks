<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4-Week Task Calendar</title>

  <!-- Google Sign-In -->
  <meta name="google-signin-client_id" content="328251555874-15b0ha0ptqme9l6hoggt9kecdvd1npqb.apps.googleusercontent.com" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #333;
    }

    header {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    .muted {
      color: #cbd4e3;
      font-size: 12px;
    }

    .btn {
      appearance: none;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      background: #2b3f8f;
      color: #fff;
      font-size: 12px;
    }

    .btn.secondary {
      background: #1f2b5b;
    }

    .hidden {
      display: none !important;
    }

    .tab-buttons {
      display: flex;
      background: #34495e;
    }

    .tab-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #34495e;
      color: #ecf0f1;
      cursor: pointer;
      font-size: 14px;
    }

    .tab-buttons button.active {
      background: #1abc9c;
      font-weight: bold;
    }

    main {
      padding: 10px;
    }

    .tab {
      display: none;
    }

    .tab.active {
      display: block;
    }

    /* Calendar styles */
    .calendar-container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .legend {
      margin-bottom: 10px;
      font-size: 13px;
      color: #555;
    }

    /* Old header row hidden; we embed day/location into each cell */
    .calendar-header-row {
      display: none;
    }

    .week-row {
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #ffffff;
      margin-bottom: 10px;
      padding: 6px;
    }

    .week-header {
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #555;
    }

    .days-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .day-cell {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      min-height: 130px;
    }

    .day-loc-time {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 3px;
      font-size: 10px;
    }

    .day-loc-time select,
    .day-loc-time input[type="time"] {
      font-size: 10px;
      padding: 1px;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 4px;
      font-weight: bold;
    }

    .day-total {
      font-weight: normal;
      font-size: 11px;
      color: #666;
    }

    .day-controls {
      display: flex;
      gap: 2px;
      margin-bottom: 4px;
    }

    .day-controls select {
      flex: 1;
      font-size: 11px;
      padding: 2px;
    }

    .task-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 11px;
      flex: 1;
      overflow-y: auto;
    }

    .task-list li {
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      padding: 2px 3px;
      border-radius: 3px;
      cursor: move;
    }

    .task-list li.dragging {
      opacity: 0.5;
    }

    .task-name {
      font-weight: bold;
    }

    .task-remove-btn {
      border: none;
      background: #e74c3c;
      color: #fff;
      border-radius: 3px;
      font-size: 10px;
      padding: 0 4px;
      cursor: pointer;
    }

    /* Task tab styles */
    .tasks-container,
    .locations-container {
      max-width: 700px;
      margin: 0 auto;
    }

    .task-form,
    .location-form {
      background: #ffffff;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 15px;
    }

    .task-form h2,
    .location-form h2 {
      margin-top: 0;
      font-size: 16px;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .form-row label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }

    .form-row input[type="text"],
    .form-row input[type="number"],
    .form-row textarea,
    .form-row select,
    .form-row input[type="color"] {
      width: 100%;
      padding: 4px;
      font-size: 12px;
    }

    .task-form textarea {
      resize: vertical;
      min-height: 40px;
    }

    .task-form button,
    .location-form button {
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .tasks-list-card,
    .locations-list-card {
      background: #ffffff;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 10px;
    }

    .tasks-list-card h2,
    .locations-list-card h2 {
      margin-top: 0;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    .no-tasks,
    .no-locations {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
    }

    /* Drag-and-drop for task DB */
    tr[data-task-index] {
      cursor: move;
    }

    tr.dragging {
      opacity: 0.5;
    }

    /* Locations tab visuals */
    .location-block {
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }

    .location-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .location-color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .location-task-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      font-size: 12px;
    }

    .location-task-list li.done span {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .location-task-list li {
      margin-bottom: 2px;
    }

    @media (max-width: 800px) {
      .days-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .week-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>4-Week Planner</h1>
      <span id="sessionText" class="muted">Not signed in</span>
    </div>
    <div class="header-right">
      <div id="signin"></div>
      <button id="signOutBtn" class="btn secondary hidden">Sign out</button>
    </div>
  </header>

  <div class="tab-buttons">
    <button id="calendarTabBtn" class="active" onclick="showTab('calendar')">Calendar</button>
    <button id="tasksTabBtn" onclick="showTab('tasks')">Tasks</button>
    <button id="locationsTabBtn" onclick="showTab('locations')">Locations</button>
  </div>

  <main>
    <!-- Calendar Tab -->
    <section id="calendarTab" class="tab active">
      <div class="calendar-container">
        <div class="legend">
          • Add tasks on <strong>Tasks</strong>, locations on <strong>Locations</strong>, then assign here.<br/>
          • Travel = +40 min (counts toward total).<br/>
          • Lunch = task with <strong>negative minutes</strong>: counts toward elapsed time, but <strong>not</strong> the total.<br/>
          • Weekly tasks: progress shown as 1/4 per location; Daily as 1/8 per location.
        </div>
        <div class="calendar-header-row" id="calendarDayHeader"></div>
        <div id="calendar"></div>
      </div>
    </section>

    <!-- Tasks Tab -->
    <section id="tasksTab" class="tab">
      <div class="tasks-container">
        <div class="task-form">
          <h2>Task Editor</h2>
          <div class="form-row">
            <div style="flex:2;">
              <label for="taskName">Task Name</label>
              <input type="text" id="taskName" placeholder="e.g. Clean classroom sinks" />
            </div>
            <div style="flex:1;">
              <label for="taskLength">Task Length (minutes)</label>
              <input type="number" id="taskLength" placeholder="30" />
            </div>
          </div>
          <div class="form-row">
            <div style="flex:2;">
              <label for="taskDescription">Task Description</label>
              <textarea id="taskDescription" placeholder="Optional details..."></textarea>
            </div>
            <div style="flex:1;">
              <label for="taskFrequency">Frequency</label>
              <select id="taskFrequency">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
                <option value="one-time">One-time</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div style="flex:1;">
              <label for="taskLocation">Location</label>
              <select id="taskLocation">
                <!-- filled dynamically -->
              </select>
            </div>
          </div>
          <button id="taskFormSubmitBtn" onclick="handleTaskFormSubmit()">Add Task to List</button>
          <button id="taskFormCancelBtn" style="display:none;margin-left:8px;" onclick="cancelEditTask()">Cancel Edit</button>
        </div>

        <div class="tasks-list-card">
          <h2>Current Tasks (drag to reorder)</h2>
          <div id="tasksTableWrapper"></div>
        </div>
      </div>
    </section>

    <!-- Locations Tab -->
    <section id="locationsTab" class="tab">
      <div class="locations-container">
        <div class="location-form">
          <h2>Locations</h2>
          <div class="form-row">
            <div style="flex:2;">
              <label for="locationName">Location Name</label>
              <input type="text" id="locationName" placeholder="e.g. OVA Holly Springs" />
            </div>
            <div style="flex:1;">
              <label for="locationColor">Highlight Color</label>
              <input type="color" id="locationColor" value="#ffffaa" />
            </div>
          </div>
          <button id="locationFormSubmitBtn" onclick="handleLocationFormSubmit()">Add Location</button>
          <button id="locationFormCancelBtn" style="display:none;margin-left:8px;" onclick="cancelEditLocation()">Cancel Edit</button>
        </div>

        <div class="locations-list-card">
          <h2>Monthly Checklist by Location</h2>
          <div id="locationsListWrapper"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const dayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    let tasks = []; // {id, name, description, lengthMinutes, frequency, location:'all'|number}
    let nextTaskId = 1;

    // assignments[week][day] = [{type:'task', taskId}, {type:'travel', locationId}]
    let assignments = [];

    // Locations
    let locations = []; // {id, name, color}
    let nextLocationId = 1;

    // Per-cell settings: dayCellSettings[week][day] = { startLocationId, startTime: "HH:MM" | null }
    let dayCellSettings = [];

    // Editing state
    let editingTaskId = null;
    let editingLocationId = null;
    let draggedTaskIndex = null; // for DB drag
    let calendarDragSource = null; // {weekIndex, dayIndex, entryIndex}

    // Storage keys
    const STORAGE_KEY_TASKS = "planner_tasks_v1";
    const STORAGE_KEY_ASSIGNMENTS = "planner_assignments_v1";
    const STORAGE_KEY_LOCATIONS = "planner_locations_v1";
    const STORAGE_KEY_DAYCELLSETTINGS = "planner_daycellsettings_v1";

    // ====== Login state / config ======
    const ADMIN_EMAILS = new Set(['johnpaulcheramie@gmail.com']);
    const LOGIN_STORAGE_KEY = 'planner_google_session_v1';
    const CLIENT_ID = document.querySelector('meta[name="google-signin-client_id"]').content;

    const loginState = {
      user: null,   // { email, name }
      role: 'guest' // 'admin' | 'user' | 'guest'
    };

    const loginEls = {
      signin: null,
      signOutBtn: null,
      sessionText: null
    };

    // ====== Core persistence ======
    function initAssignments() {
      assignments = [];
      for (let w = 0; w < 4; w++) {
        const week = [];
        for (let d = 0; d < 7; d++) {
          week.push([]);
        }
        assignments.push(week);
      }
    }

    function initDayCellSettings() {
      dayCellSettings = [];
      for (let w = 0; w < 4; w++) {
        const row = [];
        for (let d = 0; d < 7; d++) {
          row.push({ startLocationId: null, startTime: null });
        }
        dayCellSettings.push(row);
      }
    }

    function saveState() {
      if (!window.localStorage) return;
      try {
        localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(tasks));
        localStorage.setItem(STORAGE_KEY_ASSIGNMENTS, JSON.stringify(assignments));
        localStorage.setItem(STORAGE_KEY_LOCATIONS, JSON.stringify(locations));
        localStorage.setItem(STORAGE_KEY_DAYCELLSETTINGS, JSON.stringify(dayCellSettings));
      } catch (e) {
        console.warn("Unable to save state:", e);
      }
    }

    function loadState() {
      let storedTasks = null;
      let storedAssignments = null;
      let storedLocations = null;
      let storedSettings = null;

      if (window.localStorage) {
        try {
          storedTasks = localStorage.getItem(STORAGE_KEY_TASKS);
          storedAssignments = localStorage.getItem(STORAGE_KEY_ASSIGNMENTS);
          storedLocations = localStorage.getItem(STORAGE_KEY_LOCATIONS);
          storedSettings = localStorage.getItem(STORAGE_KEY_DAYCELLSETTINGS);
        } catch (e) {
          console.warn("Unable to load state:", e);
        }
      }

      // Tasks
      tasks = storedTasks ? JSON.parse(storedTasks) || [] : [];
      tasks.forEach(t => {
        if (!("location" in t)) t.location = "all";
      });

      // Assignments
      if (storedAssignments) {
        try {
          assignments = JSON.parse(storedAssignments) || [];
        } catch {
          assignments = [];
        }
      }
      if (!Array.isArray(assignments) || assignments.length !== 4) {
        initAssignments();
      } else {
        for (let w = 0; w < 4; w++) {
          if (!Array.isArray(assignments[w])) assignments[w] = [];
          for (let d = 0; d < 7; d++) {
            if (!Array.isArray(assignments[w][d])) assignments[w][d] = [];
            assignments[w][d] = assignments[w][d].map(entry => {
              if (typeof entry === "number") {
                return { type: "task", taskId: entry };
              } else if (entry && typeof entry === "object") {
                if (!entry.type) {
                  return { type: "task", taskId: entry.taskId || entry.id || 0 };
                }
                return entry;
              }
              return { type: "task", taskId: 0 };
            });
          }
        }
      }

      // Locations
      locations = storedLocations ? JSON.parse(storedLocations) || [] : [];

      // Day cell settings
      if (storedSettings) {
        try {
          dayCellSettings = JSON.parse(storedSettings) || [];
        } catch {
          dayCellSettings = [];
        }
      }
      if (!Array.isArray(dayCellSettings) || dayCellSettings.length !== 4) {
        initDayCellSettings();
      } else {
        for (let w = 0; w < 4; w++) {
          if (!Array.isArray(dayCellSettings[w])) dayCellSettings[w] = [];
          for (let d = 0; d < 7; d++) {
            if (!dayCellSettings[w][d]) {
              dayCellSettings[w][d] = { startLocationId: null, startTime: null };
            } else {
              if (!("startLocationId" in dayCellSettings[w][d])) {
                dayCellSettings[w][d].startLocationId = null;
              }
              if (!("startTime" in dayCellSettings[w][d])) {
                dayCellSettings[w][d].startTime = null;
              }
            }
          }
        }
      }

      // Next IDs
      let maxTaskId = 0;
      tasks.forEach(t => {
        if (typeof t.id === "number" && t.id > maxTaskId) maxTaskId = t.id;
      });
      nextTaskId = maxTaskId + 1;

      let maxLocId = 0;
      locations.forEach(l => {
        if (typeof l.id === "number" && l.id > maxLocId) maxLocId = l.id;
      });
      nextLocationId = maxLocId + 1;
    }

    // ---- Tabs ----
    function showTab(tab) {
      const calendarTab = document.getElementById("calendarTab");
      const tasksTab = document.getElementById("tasksTab");
      const locationsTab = document.getElementById("locationsTab");
      const calendarBtn = document.getElementById("calendarTabBtn");
      const tasksBtn = document.getElementById("tasksTabBtn");
      const locationsBtn = document.getElementById("locationsTabBtn");

      calendarTab.classList.remove("active");
      tasksTab.classList.remove("active");
      locationsTab.classList.remove("active");
      calendarBtn.classList.remove("active");
      tasksBtn.classList.remove("active");
      locationsBtn.classList.remove("active");

      if (tab === "calendar") {
        calendarTab.classList.add("active");
        calendarBtn.classList.add("active");
      } else if (tab === "tasks") {
        tasksTab.classList.add("active");
        tasksBtn.classList.add("active");
      } else {
        locationsTab.classList.add("active");
        locationsBtn.classList.add("active");
      }
    }

    // ---- Utils ----
    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function formatFrequency(freq) {
      switch (freq) {
        case "daily": return "Daily";
        case "weekly": return "Weekly";
        case "monthly": return "Monthly";
        case "yearly": return "Yearly";
        case "one-time": return "One-time";
        default: return freq;
      }
    }

    function formatMinutesToHHMM(mins) {
      const total = mins || 0;
      const h = Math.floor(total / 60);
      const m = total % 60;
      const hh = String(h).padStart(2, "0");
      const mm = String(m).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function formatMinutesTo12hTime(mins) {
      let total = mins;
      if (total < 0) total = 0;
      total = total % (24 * 60);
      const h = Math.floor(total / 60);
      const m = total % 60;
      const period = h >= 12 ? "pm" : "am";
      let displayH = h % 12;
      if (displayH === 0) displayH = 12;
      const mm = String(m).padStart(2, "0");
      return `${displayH}:${mm}${period}`;
    }

    function getLocationNameByValue(val) {
      if (val === "all") return "All locations";
      const idNum = typeof val === "number" ? val : parseInt(val, 10);
      if (!idNum) return "";
      const loc = locations.find(l => l.id === idNum);
      return loc ? loc.name : "(Unknown location)";
    }

    function getLocationColorById(id) {
      if (!id) return null;
      const loc = locations.find(l => l.id === id);
      return loc ? loc.color : null;
    }

    // ---- Task form ----
    function populateTaskLocationOptions(selectedValue) {
      const select = document.getElementById("taskLocation");
      if (!select) return;
      const current = selectedValue !== undefined ? selectedValue : (select.value || "all");

      select.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "All locations";
      select.appendChild(optAll);

      locations.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = String(loc.id);
        opt.textContent = loc.name;
        select.appendChild(opt);
      });

      if (current != null) {
        select.value = String(current);
      }
    }

    function handleTaskFormSubmit() {
      const nameInput = document.getElementById("taskName");
      const descInput = document.getElementById("taskDescription");
      const lengthInput = document.getElementById("taskLength");
      const freqSelect = document.getElementById("taskFrequency");
      const locSelect = document.getElementById("taskLocation");

      const name = nameInput.value.trim();
      const desc = descInput.value.trim();
      const lengthMinutes = parseInt(lengthInput.value, 10);
      const frequency = freqSelect.value;
      const rawLoc = locSelect.value || "all";
      const locationVal = rawLoc === "all" ? "all" : parseInt(rawLoc, 10);

      if (!name) {
        alert("Please enter a task name.");
        return;
      }
      if (isNaN(lengthMinutes)) {
        alert("Please enter a number of minutes (can be negative for lunch).");
        return;
      }

      if (editingTaskId === null) {
        const newTask = {
          id: nextTaskId++,
          name,
          description: desc,
          lengthMinutes,
          frequency,
          location: locationVal
        };
        tasks.push(newTask);
      } else {
        const task = tasks.find(t => t.id === editingTaskId);
        if (task) {
          task.name = name;
          task.description = desc;
          task.lengthMinutes = lengthMinutes;
          task.frequency = frequency;
          task.location = locationVal;
        }
      }

      editingTaskId = null;
      document.getElementById("taskFormSubmitBtn").textContent = "Add Task to List";
      document.getElementById("taskFormCancelBtn").style.display = "none";

      nameInput.value = "";
      descInput.value = "";
      lengthInput.value = "";
      freqSelect.value = "daily";
      populateTaskLocationOptions("all");

      renderTaskList();
      renderCalendar();
      renderLocationsTab();
      saveState();
    }

    function startEditTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      editingTaskId = taskId;
      document.getElementById("taskName").value = task.name;
      document.getElementById("taskDescription").value = task.description || "";
      document.getElementById("taskLength").value = task.lengthMinutes;
      document.getElementById("taskFrequency").value = task.frequency;
      populateTaskLocationOptions(task.location || "all");

      document.getElementById("taskFormSubmitBtn").textContent = "Save Changes";
      document.getElementById("taskFormCancelBtn").style.display = "inline-block";

      showTab("tasks");
    }

    function cancelEditTask() {
      editingTaskId = null;
      document.getElementById("taskName").value = "";
      document.getElementById("taskDescription").value = "";
      document.getElementById("taskLength").value = "";
      document.getElementById("taskFrequency").value = "daily";
      populateTaskLocationOptions("all");
      document.getElementById("taskFormSubmitBtn").textContent = "Add Task to List";
      document.getElementById("taskFormCancelBtn").style.display = "none";
    }

    function deleteTask(taskId) {
      if (!confirm("Delete this task and remove it from the calendar?")) return;

      // Remove from tasks list
      tasks = tasks.filter(t => t.id !== taskId);

      // If editing this task, reset form
      if (editingTaskId === taskId) {
        cancelEditTask();
      }

      // Remove from all assignments
      for (let w = 0; w < 4; w++) {
        for (let d = 0; d < 7; d++) {
          assignments[w][d] = assignments[w][d].filter(
            entry => !(entry.type === "task" && entry.taskId === taskId)
          );
        }
      }

      saveState();
      renderTaskList();
      renderCalendar();
      renderLocationsTab();
    }

    // ---- Task DB table + drag ----
    function renderTaskList() {
      const wrapper = document.getElementById("tasksTableWrapper");
      if (tasks.length === 0) {
        wrapper.innerHTML = '<p class="no-tasks">No tasks yet. Add some above.</p>';
        return;
      }

      let html = '<table><thead><tr>';
      html += "<th>#</th><th>Name</th><th>Description</th><th>Length (min)</th><th>Frequency</th><th>Location</th><th>Actions</th>";
      html += "</tr></thead><tbody>";

      tasks.forEach((task, index) => {
        html += `<tr data-task-index="${index}">
          <td>${task.id}</td>
          <td>${escapeHtml(task.name)}</td>
          <td>${escapeHtml(task.description || "")}</td>
          <td>${task.lengthMinutes}</td>
          <td>${formatFrequency(task.frequency)}</td>
          <td>${escapeHtml(getLocationNameByValue(task.location))}</td>
          <td>
            <button onclick="startEditTask(${task.id})">Edit</button>
            <button onclick="deleteTask(${task.id})">Delete</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table>";
      wrapper.innerHTML = html;

      attachDragAndDropToTaskRows();
    }

    function attachDragAndDropToTaskRows() {
      const wrapper = document.getElementById("tasksTableWrapper");
      const rows = wrapper.querySelectorAll("tbody tr[data-task-index]");

      rows.forEach(row => {
        row.draggable = true;

        row.addEventListener("dragstart", function () {
          draggedTaskIndex = parseInt(this.dataset.taskIndex, 10);
          this.classList.add("dragging");
        });

        row.addEventListener("dragover", function (e) {
          e.preventDefault();
        });

        row.addEventListener("drop", function (e) {
          e.preventDefault();
          const targetIndex = parseInt(this.dataset.taskIndex, 10);
          if (
            draggedTaskIndex === null ||
            isNaN(draggedTaskIndex) ||
            isNaN(targetIndex) ||
            draggedTaskIndex === targetIndex
          ) {
            this.classList.remove("dragging");
            return;
          }
          const moved = tasks.splice(draggedTaskIndex, 1)[0];
          tasks.splice(targetIndex, 0, moved);
          draggedTaskIndex = null;
          saveState();
          renderTaskList();
          renderCalendar();
          renderLocationsTab();
        });

        row.addEventListener("dragend", function () {
          this.classList.remove("dragging");
        });
      });
    }

    // ---- Locations form ----
    function handleLocationFormSubmit() {
      const nameInput = document.getElementById("locationName");
      const colorInput = document.getElementById("locationColor");

      const name = nameInput.value.trim();
      const color = colorInput.value || "#ffffaa";

      if (!name) {
        alert("Please enter a location name.");
        return;
      }

      if (editingLocationId === null) {
        const newLoc = {
          id: nextLocationId++,
          name,
          color
        };
        locations.push(newLoc);
      } else {
        const loc = locations.find(l => l.id === editingLocationId);
        if (loc) {
          loc.name = name;
          loc.color = color;
        }
      }

      editingLocationId = null;
      document.getElementById("locationFormSubmitBtn").textContent = "Add Location";
      document.getElementById("locationFormCancelBtn").style.display = "none";
      nameInput.value = "";
      colorInput.value = "#ffffaa";

      populateTaskLocationOptions();
      renderCalendar();
      renderLocationsTab();
      saveState();
    }

    function startEditLocation(locId) {
      const loc = locations.find(l => l.id === locId);
      if (!loc) return;

      editingLocationId = locId;
      document.getElementById("locationName").value = loc.name;
      document.getElementById("locationColor").value = loc.color || "#ffffaa";
      document.getElementById("locationFormSubmitBtn").textContent = "Save Location";
      document.getElementById("locationFormCancelBtn").style.display = "inline-block";
      showTab("locations");
    }

    function cancelEditLocation() {
      editingLocationId = null;
      document.getElementById("locationName").value = "";
      document.getElementById("locationColor").value = "#ffffaa";
      document.getElementById("locationFormSubmitBtn").textContent = "Add Location";
      document.getElementById("locationFormCancelBtn").style.display = "none";
    }

    // ---- Frequency rules ----
    function isTaskBlockedForCell(task, weekIndex, dayIndex) {
      const taskId = task.id;
      const entries = assignments[weekIndex][dayIndex];

      if (task.frequency === "daily") {
        return entries.some(e => e.type === "task" && e.taskId === taskId);
      }

      if (task.frequency === "weekly") {
        for (let d = 0; d < 7; d++) {
          const e = assignments[weekIndex][d];
          if (e.some(x => x.type === "task" && x.taskId === taskId)) {
            return true;
          }
        }
        return false;
      }

      if (["monthly", "yearly", "one-time"].includes(task.frequency)) {
        for (let w = 0; w < 4; w++) {
          for (let d = 0; d < 7; d++) {
            const e = assignments[w][d];
            if (e.some(x => x.type === "task" && x.taskId === taskId)) {
              return true;
            }
          }
        }
        return false;
      }

      return false;
    }

    function addTaskToCell(weekIndex, dayIndex, taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      if (isTaskBlockedForCell(task, weekIndex, dayIndex)) {
        alert("This task can't be added here based on its frequency rules.");
        return;
      }
      assignments[weekIndex][dayIndex].push({ type: "task", taskId });
      renderCalendar();
      renderLocationsTab();
      saveState();
    }

    function addTravelToCell(weekIndex, dayIndex, locationId) {
      const loc = locations.find(l => l.id === locationId);
      if (!loc) return;
      assignments[weekIndex][dayIndex].push({ type: "travel", locationId });
      renderCalendar();
      renderLocationsTab();
      saveState();
    }

    function removeAssignment(weekIndex, dayIndex, entryIndex) {
      assignments[weekIndex][dayIndex].splice(entryIndex, 1);
      renderCalendar();
      renderLocationsTab();
      saveState();
    }

    // ---- Calendar rendering + drag & drop ----
    function renderCalendar() {
      const calendarEl = document.getElementById("calendar");
      calendarEl.innerHTML = "";

      for (let w = 0; w < 4; w++) {
        const weekRow = document.createElement("div");
        weekRow.className = "week-row";

        const weekHeader = document.createElement("div");
        weekHeader.className = "week-header";
        weekHeader.textContent = `Week ${w + 1} – Total: 00:00`;
        weekRow.appendChild(weekHeader);

        const daysRow = document.createElement("div");
        daysRow.className = "days-row";

        let weekTotalMinutes = 0;

        for (let d = 0; d < 7; d++) {
          const dayCell = document.createElement("div");
          dayCell.className = "day-cell";

          const settings = dayCellSettings[w][d] || { startLocationId: null, startTime: null };

          const locTimeDiv = document.createElement("div");
          locTimeDiv.className = "day-loc-time";

          const locSelect = document.createElement("select");
          const locDefault = document.createElement("option");
          locDefault.value = "";
          locDefault.textContent = "Location";
          locSelect.appendChild(locDefault);
          locations.forEach(loc => {
            const opt = document.createElement("option");
            opt.value = String(loc.id);
            opt.textContent = loc.name;
            locSelect.appendChild(opt);
          });
          if (settings.startLocationId) {
            locSelect.value = String(settings.startLocationId);
          }
          locSelect.addEventListener("change", () => {
            const val = locSelect.value;
            settings.startLocationId = val ? parseInt(val, 10) : null;
            saveState();
            renderCalendar();
            renderLocationsTab();
          });

          const timeInput = document.createElement("input");
          timeInput.type = "time";
          timeInput.value = settings.startTime || "";
          timeInput.addEventListener("change", () => {
            settings.startTime = timeInput.value || null;
            saveState();
            renderCalendar();
          });

          locTimeDiv.appendChild(locSelect);
          locTimeDiv.appendChild(timeInput);

          const dayHeader = document.createElement("div");
          dayHeader.className = "day-header";

          const dayNameSpan = document.createElement("span");
          dayNameSpan.textContent = dayNames[d];

          const dayTotalSpan = document.createElement("span");
          dayTotalSpan.className = "day-total";
          dayTotalSpan.textContent = "00:00";

          dayHeader.appendChild(dayNameSpan);
          dayHeader.appendChild(dayTotalSpan);

          const dayControls = document.createElement("div");
          dayControls.className = "day-controls";

          const select = document.createElement("select");
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = tasks.length === 0 && locations.length === 0 ? "No items yet" : "Add...";
          select.appendChild(defaultOption);

          // Tasks
          tasks.forEach(task => {
            if (!isTaskBlockedForCell(task, w, d)) {
              const opt = document.createElement("option");
              opt.value = `task:${task.id}`;
              opt.textContent = `${task.name} (${task.lengthMinutes}m, ${formatFrequency(task.frequency)})`;
              select.appendChild(opt);
            }
          });

          // Travel options
          if (locations.length > 0) {
            const optGroup = document.createElement("optgroup");
            optGroup.label = "Travel";
            locations.forEach(loc => {
              const opt = document.createElement("option");
              opt.value = `travel:${loc.id}`;
              opt.textContent = `Travel to ${loc.name}`;
              optGroup.appendChild(opt);
            });
            select.appendChild(optGroup);
          }

          select.addEventListener("change", () => {
            const val = select.value;
            if (!val) return;
            if (val.startsWith("task:")) {
              const id = parseInt(val.split(":")[1], 10);
              addTaskToCell(w, d, id);
            } else if (val.startsWith("travel:")) {
              const locId = parseInt(val.split(":")[1], 10);
              addTravelToCell(w, d, locId);
            }
            select.value = "";
          });

          dayControls.appendChild(select);

          const taskList = document.createElement("ul");
          taskList.className = "task-list";

          const dayEntries = assignments[w][d];

          const startStr = settings.startTime || "08:00";
          let startMinutes = 8 * 60;
          if (/^\d{2}:\d{2}$/.test(startStr)) {
            const parts = startStr.split(":");
            const h = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            if (!isNaN(h) && !isNaN(m)) {
              startMinutes = h * 60 + m;
            }
          }
          let currentTimeMinutes = startMinutes;
          let dayTotalMinutes = 0;
          let currentLocId = settings.startLocationId || null;

          dayEntries.forEach((entry, entryIndex) => {
            const li = document.createElement("li");
            li.dataset.weekIndex = String(w);
            li.dataset.dayIndex = String(d);
            li.dataset.entryIndex = String(entryIndex);
            li.draggable = true;

            let entryLocId = currentLocId;
            const infoSpan = document.createElement("span");

            if (entry.type === "task") {
              const task = tasks.find(t => t.id === entry.taskId);
              if (!task) return;

              const len = Math.abs(task.lengthMinutes || 0);
              if (task.lengthMinutes >= 0) {
                dayTotalMinutes += len;
              }
              currentTimeMinutes += len;

              infoSpan.innerHTML =
                `<span class="task-name">${escapeHtml(task.name)}</span> (${task.lengthMinutes}m)`;
            } else if (entry.type === "travel") {
              const locName = getLocationNameByValue(entry.locationId);
              const travelStart = currentTimeMinutes;
              const travelDuration = 40;
              dayTotalMinutes += travelDuration;
              currentTimeMinutes += travelDuration;
              currentLocId = entry.locationId || null;
              entryLocId = currentLocId;

              const timeLabel = formatMinutesTo12hTime(travelStart);
              infoSpan.innerHTML =
                `<span class="task-name">Travel</span> → ${escapeHtml(locName)} at ${timeLabel}`;
            }

            const color = getLocationColorById(entryLocId);
            if (color) {
              li.style.backgroundColor = color;
            }

            const removeBtn = document.createElement("button");
            removeBtn.className = "task-remove-btn";
            removeBtn.textContent = "✕";
            removeBtn.addEventListener("click", () => {
              removeAssignment(w, d, entryIndex);
            });

            li.appendChild(infoSpan);
            li.appendChild(removeBtn);
            taskList.appendChild(li);

            // Drag & drop for calendar entries
            li.addEventListener("dragstart", () => {
              calendarDragSource = { weekIndex: w, dayIndex: d, entryIndex };
              li.classList.add("dragging");
            });

            li.addEventListener("dragend", () => {
              li.classList.remove("dragging");
              calendarDragSource = null;
            });

            li.addEventListener("dragover", (e) => {
              e.preventDefault();
            });

            li.addEventListener("drop", (e) => {
              e.preventDefault();
              if (!calendarDragSource) return;
              const source = calendarDragSource;
              const targetWeek = w;
              const targetDay = d;
              let targetIndex = entryIndex;

              const sourceEntries = assignments[source.weekIndex][source.dayIndex];
              const entryObj = sourceEntries.splice(source.entryIndex, 1)[0];

              if (source.weekIndex === targetWeek && source.dayIndex === targetDay && targetIndex > source.entryIndex) {
                targetIndex--;
              }

              const targetEntries = assignments[targetWeek][targetDay];
              targetEntries.splice(targetIndex, 0, entryObj);

              calendarDragSource = null;
              saveState();
              renderCalendar();
              renderLocationsTab();
            });
          });

          // Drop into empty / bottom of list
          taskList.addEventListener("dragover", (e) => {
            e.preventDefault();
          });

          taskList.addEventListener("drop", (e) => {
            e.preventDefault();
            if (!calendarDragSource) return;
            const source = calendarDragSource;
            const targetWeek = w;
            const targetDay = d;

            const sourceEntries = assignments[source.weekIndex][source.dayIndex];
            const entryObj = sourceEntries.splice(source.entryIndex, 1)[0];

            const targetEntries = assignments[targetWeek][targetDay];
            targetEntries.push(entryObj);

            calendarDragSource = null;
            saveState();
            renderCalendar();
            renderLocationsTab();
          });

          dayTotalSpan.textContent = formatMinutesToHHMM(dayTotalMinutes);
          weekTotalMinutes += dayTotalMinutes;

          dayCell.appendChild(locTimeDiv);
          dayCell.appendChild(dayHeader);
          dayCell.appendChild(dayControls);
          dayCell.appendChild(taskList);
          daysRow.appendChild(dayCell);
        }

        weekHeader.textContent = `Week ${w + 1} – Total: ${formatMinutesToHHMM(weekTotalMinutes)}`;
        weekRow.appendChild(daysRow);
        calendarEl.appendChild(weekRow);
      }
    }

    // ---- Location progress computations ----
    function computeLocationTaskStats(locationId) {
      const stats = new Map(); // taskId -> {occurrences, weeks:Set}

      for (let w = 0; w < 4; w++) {
        for (let d = 0; d < 7; d++) {
          const settings = dayCellSettings[w][d] || { startLocationId: null, startTime: null };
          let currentLocId = settings.startLocationId || null;

          const dayEntries = assignments[w][d];
          dayEntries.forEach(entry => {
            if (entry.type === "travel") {
              currentLocId = entry.locationId || null;
            } else if (entry.type === "task") {
              if (currentLocId === locationId) {
                const taskId = entry.taskId;
                let rec = stats.get(taskId);
                if (!rec) {
                  rec = { occurrences: 0, weeks: new Set() };
                  stats.set(taskId, rec);
                }
                rec.occurrences++;
                rec.weeks.add(w);
              }
            }
          });
        }
      }

      return stats;
    }

    function renderLocationsTab() {
      const wrapper = document.getElementById("locationsListWrapper");
      if (locations.length === 0) {
        wrapper.innerHTML = '<p class="no-locations">No locations yet. Add some above.</p>';
        return;
      }

      let html = "";

      locations.forEach(loc => {
        const stats = computeLocationTaskStats(loc.id);
        const relevantTasks = tasks.filter(
          t => t.location === "all" || t.location === loc.id
        );

        html += `<div class="location-block">
          <div class="location-header">
            <div class="location-color-swatch" style="background-color:${loc.color || "#ffffff"};"></div>
            <strong>${escapeHtml(loc.name)}</strong>
            <button onclick="startEditLocation(${loc.id})">Edit</button>
          </div>`;

        if (relevantTasks.length === 0) {
          html += `<p class="no-tasks">No tasks assigned to this location yet.</p>`;
        } else {
          html += `<ul class="location-task-list">`;
          relevantTasks.forEach(task => {
            const stat = stats.get(task.id);
            let extra = "";
            let done = false;

            if (task.frequency === "weekly") {
              const doneWeeks = stat ? stat.weeks.size : 0;
              extra = ` – ${doneWeeks}/4`;
              done = doneWeeks >= 4;
            } else if (task.frequency === "daily") {
              const occ = stat ? stat.occurrences : 0;
              extra = ` – ${occ}/8`;
              done = occ >= 8;
            } else {
              const occ = stat ? stat.occurrences : 0;
              done = occ > 0;
            }

            html += `<li class="${done ? "done" : ""}">
              <span>${escapeHtml(task.name)} (${task.lengthMinutes}m, ${formatFrequency(task.frequency)})${extra}</span>
            </li>`;
          });
          html += `</ul>`;
        }

        html += `</div>`;
      });

      wrapper.innerHTML = html;
    }

    function renderCalendarHeader() {
      const headerRow = document.getElementById("calendarDayHeader");
      if (!headerRow) return;
      headerRow.innerHTML = "";
    }

    // ====== Google login helpers (from old tool, simplified) ======
    function decodeJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
        const json = atob(base64);
        return JSON.parse(decodeURIComponent(Array.prototype.map.call(
          json,
          c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('')));
      } catch {
        return null;
      }
    }

    function updateLoginUI() {
      if (!loginEls.sessionText || !loginEls.signOutBtn) return;

      if (loginState.user) {
        const u = loginState.user;
        loginEls.sessionText.textContent = `Signed in as ${u.name || u.email}`;
        loginEls.signOutBtn.classList.remove('hidden');
        if (loginEls.signin) {
          loginEls.signin.innerHTML = '';
        }
      } else {
        loginEls.sessionText.textContent = 'Not signed in';
        loginEls.signOutBtn.classList.add('hidden');
      }
    }

    function renderSignInButton() {
      if (!loginEls.signin) return;

      // If already logged in, no need to render button
      if (loginState.user) {
        loginEls.signin.innerHTML = '';
        return;
      }

      loginEls.signin.innerHTML = '';

      if (!(window.google && google.accounts && google.accounts.id)) {
        // Try again after a short delay if library isn't ready yet
        const span = document.createElement('span');
        span.className = 'muted';
        span.textContent = 'Loading sign-in…';
        loginEls.signin.appendChild(span);
        setTimeout(renderSignInButton, 500);
        return;
      }

      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: (resp) => {
          const p = decodeJwt(resp.credential);
          if (!p) return;
          const email = String(p.email || '').toLowerCase();
          loginState.user = { email, name: p.name || '' };
          loginState.role = ADMIN_EMAILS.has(email) ? 'admin' : 'user';
          try {
            localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify(loginState));
          } catch {}
          updateLoginUI();
          loginEls.signin.innerHTML = '';
        },
        auto_select: false,
        ux_mode: 'popup'
      });

      const btnContainer = document.createElement('div');
      loginEls.signin.appendChild(btnContainer);
      google.accounts.id.renderButton(btnContainer, {
        theme: 'filled_blue',
        size: 'medium'
      });
    }

    function initLogin() {
      loginEls.signin = document.getElementById('signin');
      loginEls.signOutBtn = document.getElementById('signOutBtn');
      loginEls.sessionText = document.getElementById('sessionText');

      // Restore previous login if any
      try {
        const raw = localStorage.getItem(LOGIN_STORAGE_KEY);
        if (raw) {
          const saved = JSON.parse(raw);
          if (saved && saved.user) {
            loginState.user = saved.user;
            loginState.role = saved.role || 'user';
          }
        }
      } catch {}

      if (loginEls.signOutBtn) {
        loginEls.signOutBtn.addEventListener('click', () => {
          loginState.user = null;
          loginState.role = 'guest';
          try {
            localStorage.removeItem(LOGIN_STORAGE_KEY);
          } catch {}
          updateLoginUI();
          renderSignInButton();
        });
      }

      updateLoginUI();
      renderSignInButton();
    }

    // ---- Init ----
    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      populateTaskLocationOptions();
      renderTaskList();
      renderLocationsTab();
      renderCalendarHeader();
      renderCalendar();
      initLogin();
    });
  </script>
</body>
</html>
